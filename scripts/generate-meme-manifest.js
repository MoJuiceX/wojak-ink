/**
 * Script to dynamically generate meme image manifest from wojak-creator folder structure
 * This scans the public/wojak-creator folder and generates the manifest automatically
 * Run with: npm run generate-meme-manifest
 * The manifest is automatically generated on build (see package.json)
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const PUBLIC_DIR = path.join(__dirname, '..', 'public')
const WOJAK_CREATOR_DIR = path.join(PUBLIC_DIR, 'wojak-creator')
const MANIFEST_FILE = path.join(__dirname, '..', 'src', 'lib', 'memeImageManifest.js')

// Folder names in wojak-creator directory
const FOLDER_NAMES = ['BACKGROUND', 'BASE', 'CLOTHES', 'EYE', 'HEAD', 'MOUTH', 'EXTRA']

// Map folder names to layer names (used in code)
const FOLDER_TO_LAYER_MAP = {
  'BACKGROUND': 'Background',
  'BASE': 'Base',
  'CLOTHES': 'Clothes',
  'EYE': 'Eyes',
  'HEAD': 'Head',
  'MOUTH': 'Mouth',
  'EXTRA': 'Extra',
}

/**
 * Get all PNG files in a directory
 */
function getPngFiles(dir) {
  if (!fs.existsSync(dir)) {
    return []
  }
  
  const files = fs.readdirSync(dir, { withFileTypes: true })
  const pngFiles = []
  
  for (const file of files) {
    if (file.isFile() && file.name.toLowerCase().endsWith('.png')) {
      pngFiles.push(file.name)
    }
  }
  
  return pngFiles.sort()
}

/**
 * Get subdirectories in a directory
 */
function getSubdirectories(dir) {
  if (!fs.existsSync(dir)) {
    return []
  }
  
  const files = fs.readdirSync(dir, { withFileTypes: true })
  return files
    .filter(file => file.isDirectory())
    .map(file => file.name)
    .sort()
}

/**
 * Scan a layer folder and build manifest structure
 */
function scanLayerFolder(layerName) {
  const layerDir = path.join(WOJAK_CREATOR_DIR, layerName)
  
  if (!fs.existsSync(layerDir)) {
    console.warn(`Warning: Layer folder ${layerName} does not exist`)
    return {}
  }
  
  const manifest = {}
  
  // Check for subdirectories
  const subdirs = getSubdirectories(layerDir)
  
  if (subdirs.length > 0) {
    // Has subdirectories (like Background)
    for (const subdir of subdirs) {
      const subdirPath = path.join(layerDir, subdir)
      const files = getPngFiles(subdirPath)
      if (files.length > 0) {
        manifest[subdir] = files
      }
    }
  } else {
    // No subdirectories, files are directly in the layer folder
    const files = getPngFiles(layerDir)
    if (files.length > 0) {
      manifest[''] = files
    }
  }
  
  return manifest
}

/**
 * Generate the manifest file content
 */
function generateManifestContent(manifest) {
  // Convert manifest to formatted string with proper escaping
  const formatValue = (value, indent = 0) => {
    const spaces = '  '.repeat(indent)
    if (Array.isArray(value)) {
      if (value.length === 0) return '[]'
      return `[\n${value.map(v => {
        const escaped = v.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
        return `${spaces}  '${escaped}'`
      }).join(',\n')}\n${spaces}]`
    }
    if (typeof value === 'object' && value !== null) {
      const entries = Object.entries(value)
      if (entries.length === 0) return '{}'
      return `{\n${entries.map(([k, v]) => {
        const key = k === '' ? "''" : `'${k.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'`
        return `${spaces}  ${key}: ${formatValue(v, indent + 1)}`
      }).join(',\n')}\n${spaces}}`
    }
    return `'${String(value).replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'`
  }
  
  const manifestStr = formatValue(manifest)
  
  return `// Dynamic asset loading for wojak-creator images
// The manifest is auto-generated by scripts/generate-meme-manifest.js
// To regenerate, run: npm run generate-meme-manifest
// This file is automatically updated when new assets are added

const HARDCODED_MANIFEST = ${manifestStr}

// Use the manifest (auto-generated by script)
const MANIFEST = HARDCODED_MANIFEST

// Helper function to clean display names
function cleanDisplayName(fileName, layerName) {
  const name = fileName.replace('.png', '')
  return name
    .replace(/BASE_Wojak_/g, '')
    .replace(/BASE_Base-Wojak_/g, '')
    .replace(/BACKGROUND_/g, '')
    .replace(/CLOTHES_/g, '')
    .replace(/EXTRA_/g, '')
    .replace(/EXTRA-on-tee,tank-top_CLOTHES_/g, '')
    .replace(/EYE_|EYES_/g, '')
    .replace(/HEAD_/g, '')
    .replace(/MOUTH_/g, '')
    .replace(/_/g, ' ')
    .replace(/-/g, ' ')
    .trim()
}

// Map layer names back to folder names for paths
const LAYER_TO_FOLDER_MAP = {
  'Background': 'BACKGROUND',
  'Base': 'BASE',
  'Clothes': 'CLOTHES',
  'Eyes': 'EYE',
  'Head': 'HEAD',
  'Mouth': 'MOUTH',
  'Extra': 'EXTRA',
}

// Helper function to get image path
function getImagePath(layerName, subfolder, fileName) {
  // Use /wojak-creator/ path (actual folder structure)
  // Convert layer name to folder name
  const folderName = LAYER_TO_FOLDER_MAP[layerName] || layerName
  const path = subfolder 
    ? \`/wojak-creator/\${folderName}/\${subfolder}/\${fileName}\`
    : \`/wojak-creator/\${folderName}/\${fileName}\`
  return path
}

export function getLayerImagesBySubfolder(layerName) {
  const layerData = MANIFEST[layerName]
  if (!layerData) return {}

  const organized = {}
  
  Object.keys(layerData).forEach(subfolder => {
    const files = layerData[subfolder]
    organized[subfolder] = files.map(fileName => {
      const name = fileName.replace('.png', '')
      const fullName = subfolder ? \`\${subfolder}/\${name}\` : name
      const path = getImagePath(layerName, subfolder, fileName)
      
      return {
        name,
        fullName,
        path,
        displayName: cleanDisplayName(fileName, layerName)
      }
    })
  })

  return organized
}

/**
 * Get all images from a layer, flattened (no subfolder organization)
 * @param {string} layerName - Name of the layer (Background, Base, Eyes, etc.)
 * @returns {Array} Array of image objects with name, path, and displayName
 */
export function getAllLayerImages(layerName) {
  const layerData = MANIFEST[layerName]
  if (!layerData) return []

  const allImages = []
  
  Object.keys(layerData).forEach(subfolder => {
    const files = layerData[subfolder]
    files.forEach(fileName => {
      const name = fileName.replace('.png', '')
      const path = getImagePath(layerName, subfolder, fileName)
      
      allImages.push({
        name,
        path,
        displayName: cleanDisplayName(fileName, layerName)
      })
    })
  })

  return allImages
}
`
}

/**
 * Main function
 */
function main() {
  console.log('Generating meme image manifest from wojak-creator folder...\n')
  
  if (!fs.existsSync(WOJAK_CREATOR_DIR)) {
    console.error(`Error: wojak-creator directory not found at ${WOJAK_CREATOR_DIR}`)
    process.exit(1)
  }
  
  const manifest = {}
  
  // Scan each layer folder
  for (const folderName of FOLDER_NAMES) {
    const layerName = FOLDER_TO_LAYER_MAP[folderName]
    console.log(`Scanning ${folderName} (as ${layerName})...`)
    const layerData = scanLayerFolder(folderName)
    if (Object.keys(layerData).length > 0) {
      manifest[layerName] = layerData
      const totalFiles = Object.values(layerData).flat().length
      console.log(`  Found ${totalFiles} files in ${Object.keys(layerData).length} subfolder(s)`)
    } else {
      console.log(`  No files found`)
    }
  }
  
  // Generate manifest file
  const content = generateManifestContent(manifest)
  fs.writeFileSync(MANIFEST_FILE, content, 'utf8')
  
  console.log(`\nâœ“ Manifest generated: ${MANIFEST_FILE}`)
  console.log('Done!')
}

try {
  main()
} catch (error) {
  console.error('Error:', error)
  process.exit(1)
}

